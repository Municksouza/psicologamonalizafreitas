// Set up CSRF token for AJAX requests
$.ajaxSetup({
  headers: {
    'X-CSRF-Token': $('meta[name="csrf-token"]').attr('content')
  }
});

document.addEventListener('DOMContentLoaded', function() {
  var calendarEl = document.getElementById('calendar');

  // Get the CSRF token from the meta tag generated by Rails
  var csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

  if (calendarEl) {
    var calendar = new FullCalendar.Calendar(calendarEl, {
      plugins: ['dayGrid', 'interaction'],
      initialView: 'dayGridMonth',
      selectable: true,
      editable: true,
      events: '/appointments/index_json',  // Fetch existing appointments

      // For psychologists: Create new available slots
      select: function(selectionInfo) {
        if (currentRole === 'psychologist') {
          if (confirm('Do you want to create a new available appointment slot for this time?')) {
            $.ajax({
              url: '/appointments',
              method: 'POST',
              data: {
                appointment: {
                  start_time: selectionInfo.startStr,
                  end_time: selectionInfo.endStr
                }
              },
              headers: {
                'X-CSRF-Token': csrfToken  // Include the CSRF token
              },
              success: function(response) {
                alert('Appointment slot created successfully!');
                calendar.refetchEvents();  // Refresh calendar to show new slot
              },
              error: function(xhr) {
                alert('Error creating appointment slot: ' + xhr.responseText);
              }
            });
          }
        }
      },

      // Event click for patients to book/cancel and psychologists to edit/delete
      eventClick: function(info) {
        if (currentRole === 'patient') {
          // Patients can book available slots or cancel their booked appointment
          if (info.event.extendedProps.status === 'available' && confirm('Do you want to book this appointment?')) {
            $.ajax({
              url: '/appointments/' + info.event.id + '/book',  // Correct POST URL for booking
              method: 'POST',
              headers: {
                'X-CSRF-Token': csrfToken
              },
              success: function(response) {
                alert('Appointment booked successfully!');
                calendar.refetchEvents();  // Refresh calendar after booking
              },
              error: function(xhr) {
                alert('Error booking appointment: ' + xhr.responseText);
              }
            });
          } else if (info.event.extendedProps.status === 'booked' && confirm('Do you want to cancel this appointment?')) {
            $.ajax({
              url: '/appointments/' + info.event.id + '/cancel',  // Correct POST URL for canceling
              method: 'POST',
              headers: {
                'X-CSRF-Token': csrfToken
              },
              success: function(response) {
                alert('Appointment canceled successfully!');
                calendar.refetchEvents();  // Refresh calendar after canceling
              },
              error: function(xhr) {
                alert('Error canceling appointment: ' + xhr.responseText);
              }
            });
          }
        } else if (currentRole === 'psychologist') {
          // Psychologists can edit or delete the slot
          if (confirm('Do you want to edit this appointment slot?')) {
            window.location.href = '/appointments/' + info.event.id + '/edit';
          } else if (confirm('Do you want to delete this appointment slot?')) {
            $.ajax({
              url: '/appointments/' + info.event.id,
              method: 'DELETE',
              headers: {
                'X-CSRF-Token': csrfToken
              },
              success: function(response) {
                alert('Appointment slot deleted successfully!');
                calendar.refetchEvents();  // Refresh calendar after deleting
              },
              error: function(xhr) {
                alert('Error deleting appointment slot: ' + xhr.responseText);
              }
            });
          }
        }
      }
    });

    calendar.render();  // Render the calendar on the page
  }
});
